#!/usr/bin/env node

var gulp = require('gulp');
var concat = require('gulp-concat');
var uglify = require('gulp-uglify');
var del = require('del');
var program = require('commander');
var dependencies = require('../lib/dependencies');
var LocalSet = require('../lib/localset');

// Program end
var requiredEnd = require('../lib/footer');

program
  .version('0.0.1')
  .option('-m, --methods <methods>', 'Include methods')
  .option('-l, --lite', 'Create lite build')
  .option('-c, --compat', 'Create compat build');

program.on('--help', function(){
  console.log('  Examples:');
  console.log('');
  console.log('    $ cli --methods create,filter,map,flatmap,takeuntil');
  console.log('    $ cli -m create,filter,map,flatmap,takeuntil');
  console.log('');
});

program.parse(process.argv);

var requiredFiles = new LocalSet(),
  fileLocations = [];

if (program.methods) {
  
  // Expect commas to seperate methods
  var methods = program.methods.split(',');
  if (methods.length === 0) {
    console.log('Methods are required');
    program.help();
  }

  methods.forEach(function (method) {
    var method = method.trim().toLowerCase();

    // Check if an alias
    var alias = dependencies.aliases[method];
    if (alias) {
      method = alias;
    }

    recursivelyAdd(method);

    function recursivelyAdd(m) {
      if (requiredFiles.add(m)) {
        // Check the source
        var methodData = dependencies.operators[m];
        if (!m) {
          console.log('Method not found: '+m);
          program.help();
        }

        fileLocations.push.apply(fileLocations, methodData.source);

        // Run the dependencies
        methodData.dependsOn.forEach(function (d) {
          recursivelyAdd(d);
        });
      } 
    }
  });
} else {
  // TODO: Load from file?
  console.log('Methods are required');
  program.help();
}

var requiredStart = program.compat ?
  require('../lib/headercompat') :
  require('../lib/header');

var totalFiles = requiredStart.concat(fileLocations, requiredEnd);

var outputFile = 'rx.custom.js';
var outputMinFile = 'rx.custom.min.js';

gulp.task('clean', function(cb) {
  del(['build'], cb);
});

gulp.task('concat', ['clean'], function() {
  return gulp.src(totalFiles)
    .pipe(concat(outputFile))
    .pipe(gulp.dest('build'));
});

gulp.task('minify', ['concat'], function () {
  return gulp.src(['build/' + outputFile])
    .pipe(uglify())
    .pipe(concat(outputMinFile))
    .pipe(gulp.dest('build'));
});

gulp.task('default', ['minify']);

// Start the build!
gulp.start('default');